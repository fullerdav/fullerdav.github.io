<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:svg="http://www.w3.org/2000/svg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>D3: Force layout</title>


<style type="text/css">
:root {
  font-size: .875em;
}
* {
	box-sizing: border-box;
	margin: 0; 
	padding: 0
}

#B {margin-right:5px;}
#C {margin-right:10px;}
#D {margin-right:15px;}
#E {margin-right:20px;}
#F {margin-right:24px;}
#G {margin-right:28px;}
#H {margin-right:32px;}
#I {margin-right:35px;}
#J {margin-right:36px;}
#K {margin-right:35px;}
#L {margin-right:32px;}
#M {margin-right:28px;}
#N {margin-right:24px;}
#O {margin-right:20px;}
#P {margin-right:15px;}
#Q {margin-right:10px;}
#R {margin-right:5px;}
#BBB {margin-left:5px;}
#CCC {margin-left:10px;}
#DDD {margin-left:15px;}
#EEE {margin-left:20px;}
#FFF {margin-left:24px;}
#GGG {margin-left:28px;}
#HHH {margin-left:32px;}
#III {margin-left:35px;}
#JJJ {margin-left:36px;}
#KKK {margin-left:35px;}
#LLL {margin-left:32px;}
#MMM {margin-left:28px;}
#NNN {margin-left:24px;}
#OOO {margin-left:20px;}
#PPP {margin-left:15px;}
#QQQ {margin-left:10px;}
#RRR {margin-left:5px;}

.container {
	display: grid;
	grid-template-columns: repeat(3, 1fr);
	grid-row: auto;
	margin: auto;
}

.framework {
	margin: auto 0;
	justify-self: center;
	text-align: center;
}

.framework .node {
	margin:  1rem 0;
	font-size:  1.1rem;
}
.outcomes1 {
	justify-self: end;
	justify-items: end;
	text-align: right;
	font-size:  1rem;
}

.outcomes1 .node {
 	justify-items: end;
  min-height: 2rem;
}

.outcomes2 {
	justify-self: start;
	justify-items: start;
	text-align: left;
	font-size:  1rem;
}

.outcomes2 .node {
	justify-items: start;
  min-height: 2rem;
}

.hilite {
	border-radius: 8px;
	box-shadow:  2px 2px 0 rgba(0,0,0,0.16),0 0 0 1px rgba(0,0,0,0.08);
	opacity: 1;
}

.lolite {
	opacity: .4;
}


.wac { color: teal; }
.cclo { color: blue;}
.wpa {color: orangered;}
.ilcs {color: firebrick;}
.acrl {color: indigo;}
.objective {}

.cclo rect {fill: blue;}
.wac rect {fill: teal; }
.wpa rect {fill: orangered;}
.ilcs rect {fill: firebrick;}
.acrl rect {fill: indigo;}
.objective rect {fill:#f4d442;}
.objective text {fill:#333;}


#legend {
	font-size: 11px; 
	display: inline;
	padding: 10px 0;
	float: right;
	z-index: 2;
	background-color: #fff;
	position: static;
	width: 67%;
}

.label { 
	margin-left: 4px; 
	padding: 2px 4px;
}
#wac {background:teal; height:8px; width:10px; display: inline-block; }
#wpa {background:orangered; height:10px; width:10px; display: inline-block;}
#ilcs {background: firebrick; height:10px; width:10px; display: inline-block;}
#acrl {background-color:indigo; height:10px; width:10px;display: inline-block;}
#cclo { background-color: blue;  height:10px; width:10px; display: inline-block;}

#d3force {
  position: fixed;
	background-color: #d8e7ff;
	z-index: 10;
  height: 100vh;
	width: 0%;
  margin-left: 100%;
  transition-property: width, margin-left;
  transition-duration: 1s;
  transition-timing-function: ease-out;
}

#d3force1 {
	position: fixed;
	background-color:  rgb(200,200,200);
	z-index: 9;
	height: 100vh;
	width: 0%;
  margin-right: 100%;
  transition-property: width, margin-right;
  transition-duration: 1s;
  transition-timing-function: ease-out;
}

@media (max-width: 900px) {
  #legend {
    display: none;
  }
}
@media (max-width: 1100px) {
  #legend {
    font-size: 9px;
  }
}

span {
  display: inline-block;
  padding: 8px;
}

text {
  font-size: 1em;
  line-height: 1em;
  pointer-events: inherit;
}

path.link {
  fill: none;
  stroke: #333;
  stroke-width: 1px;
}

circle.cclo {fill: blue;}
circle.wac {fill: teal; }
circle.wpa {fill: orangered;}
circle.ilcs {fill: firebrick;}
circle.acrl {fill: indigo;}
circle.objective {fill:#f4d442;}
circle.objective text {fill:#333;}


</style>
</head>

<body>
<div id="d3force1">
</div>
<div id="d3force"></div>

<div class="container">
	<div class="outcomes1">
		<div class="node" id="A"><span class="wac">Demonstrate proficiency in writing genres appropriate to the various disciplines addressed to critical readers.</span></div>
		<div class="node" id="B"><span class="wac">Demonstrate proficiency in constructing discipline appropriate claims, theses, or questions to put forward ideas in a focused manner.</span></div>
		<div class="node" id="C"><span class="wac">Use evidence appropriately to support claims.</span></div>
		<div class="node" id="D"><span class="wac">Use analysis, synthesis, reflection, argument to develop ideas, which may include organization, structure, coherence, and depth of thinking.</span></div>
		<div class="node" id="E"><span class="wac">Practice ethical and professional standards of citation.</span></div>
		<div class="node" id="F"><span class="wac">Demonstrate use of language appropriate for the audience and purpose.</span></div>
		<div class="node" id="G"><span class="wac">Integrate the ideas of others appropriately for the discipline.</span></div>
		<div class="node" id="H"><span class="wac">Use constructive feedback from readers to revise writing to be more effective in achieving its purpose for readers.</span></div>
		<div class="node" id="I"><span class="cclo">Discuss Ideas</span></div>
		<div class="node" id="J"><span class="cclo">Read Texts Critically</span></div>
		<div class="node" id="K"><span class="cclo">Develop Effective Arguments</span></div>
		<div class="node" id="L"><span class="cclo">Incorporates Revision</span></div>
		<div class="node" id="M"><span class="cclo">Develop A Research Topic</span></div>
		<div class="node" id="N"><span class="cclo">Find Evidence</span></div>
		<div class="node" id="O"><span class="cclo">Evaluate Evidence</span></div>
		<div class="node" id="P"><span class="cclo">Develop an Evidence Based Argument</span></div>
		<div class="node" id="Q"><span class="cclo">Present Research Findings</span></div>
		<div class="node" id="R"><span class="cclo">Practice Professional Standards of Citation</span></div>
		<div class="node" id="S"><span class="cclo">Make Connections or Original Contributions</span></div>


  </div>

<div class="framework">
		<div class="node" id="AA"><span class="objective">Topic Creation</span></a></div>
		<div class="node" id="BB"><span class="objective">Evolution of Research Over Time</span></div>
		<div class="node" id="CC"><span class="objective">Boolean Operators and Keyword Searching</span></div>
		<div class="node" id="DD"><span class="objective">Credibility and Evaluation</span></div>
		<div class="node" id="EE"><span class="objective">Primary and Secondary Sources</span></div>
		<div class="node" id="FF"><span class="objective">Reading Sources</span></div>
		<div class="node" id="GG"><span class="objective">When to Use What Research Tools and the Value of Each One</span></div>
		<div class="node" id="HH"><span class="objective">Citations</span></div>
		<div class="node" id="II"><span class="objective">Engaging with the Scholarly Conversation to Find Significance</span></div>
		<div class="node" id="JJ"><span class="objective">Peer Review and the Information/Publishing Cycle</span></div>
		<div class="node" id="KK"><span class="objective">Navigating Online Search and Request Systems</span></div>
		<div class="node" id="LL"><span class="objective">Ability to Navigate the Library</span></div>
</div>

<div class="outcomes2">

  		<div id="legend">
  		<div><div id="wac"></div><a target="_blank" href="https://www.union.edu/Resources/Campus/assessment/outcomes/academicaffairs/WAC.php"><span class="label">Writing Across the Curriculum Learning Outcomes</span></a></div>
  		<div><div id="cclo"></div><a target="_blank" href="http://muse.union.edu/commoncurriculum/files/2016/01/CCA-PartII-LearningOutcomes.pdf"><span class="label">Common Curriculum Learning Outcomes</span></a></div>
  		<div><div id="wpa"></div><a target="_blank" href="http://wpacouncil.org/files/framework-for-success-postsecondary-writing.pdf"><span class="label">WPA Framework Habits of Mind</span></a></div>
  		<div><div id="ilcs"></div><a target="_blank" href="http://www.ala.org/acrl/standards/informationliteracycompetency"><span class="label">Information Literacy Competency Standards</span></a></div>
  		<div><div id="acrl"></div><a target="_blank" href="http://www.ala.org/acrl/sites/ala.org.acrl/files/content/issues/infolit/Framework_ILHE.pdf"><span class="label">ACRL Information Literacy Framework</span></a></div>
      <div><div id="schaffer"></div><a target="_blank" href="https://docs.google.com/document/d/1VtsjEedFkWqKidf0wJ4Pl0iCMloiRwNJrAJspt4VtvE/edit"><span class="label">Schaffer Library IL Outcomes</span></a></div>
  	   </div>
   

		<div class="node" id="AAA"><span class="wpa">Curiosity</span></div>
		<div class="node" id="BBB"><span class="wpa">Openness</span></div>
		<div class="node" id="CCC"><span class="wpa">Engagement</span></div>
		<div class="node" id="DDD"><span class="wpa">Creativity</span></div>
		<div class="node" id="EEE"><span class="wpa">Persistence</span></div>
		<div class="node" id="FFF"><span class="wpa">Responsibility</span></div>
		<div class="node" id="GGG"><span class="wpa">Flexibility</span></div>
		<div class="node" id="HHH"><span class="wpa">Metacognition</span></div>
		<div class="node" id="III"><span class="ilcs">Individually or as a member of a group,uses information effectively to accomplish a specific purpose</span></div>
		<div class="node" id="JJJ"><span class="ilcs">Understands many of the economic, legal, and social issues surrounding thre use of information and accesses and uses information ethically and legally</span></div>
		<div class="node" id="KKK"><span class="ilcs">Determine the nature and extent of information needed</span></div>
		<div class="node" id="LLL"><span class="ilcs">Accesses needed information effectively and efficiently</span></div>
		<div class="node" id="MMM"><span class="ilcs">Evaluates information and its sources critically and incorporates selected information into her or his knowledge base or value system</span></div>
		<div class="node" id="NNN"><span class="acrl">Authority is Constructed and Contextual</span></div>
		<div class="node" id="OOO"><span class="acrl">Information Creation as a Process</span></div>
		<div class="node" id="PPP"><span class="acrl">Information has Value</span></div>
		<div class="node" id="QQQ"><span class="acrl">Research as Inquiry</span></div>
		<div class="node" id="RRR"><span class="acrl">Scholarship as Conversation</span></div>
		<div class="node" id="SSS"><span class="acrl">Searching as Strategic Exploration</span></div>
	</div>
</div>

<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
<script src="//d3js.org/d3.v4.min.js"></script>
			
		
<script>

Set.prototype.difference = function(setB) {
    var difference = new Set(this);
    for (var elem of setB) {
        difference.delete(elem);
    }
    return difference;
}

const assoc = {
	"AA":  ["B","K","M","N","DDD","KKK","SSS"],
	"BB":  ["B","J","M","N","AAA","BBB","CCC","FFF","HHH","KKK","MMM","SSS","QQQ"],
	"CC":  ["BBB","EEE","KKK","LLL","MMM","SSS","N"],
	"DD":  ["O","F","J","AAA","GGG","HHH","KKK","MMM","NNN","OOO","PPP"],
	"EE":  ["C","O","S","AAA","BBB","DDD","KKK","LLL","OOO","MMM","NNN"],
	"FF":  ["AAA","BBB","CCC","FFF","KKK","LLL","QQQ","D","J","O","P","S"],
	"GG":  ["AAA","BBB","LLL","SSS","O"],
	"HH":  ["E","R","FFF","GGG","JJJ","LLL","PPP","RRR"],
	"II":  ["BBB","CCC","FFF","MMM","III","RRR","A","C","G","H","I","L","O","P","Q","S"],
	"JJ":  ["HHH","NNN","N","O","KKK","OOO","PPP"],
	"KK":  ["KKK","LLL","MMM","R","O","EEE","SSS"],
	"LL":  ["N","LLL","SSS"]
};

var allnodes = $(".node");
var nodeset = new Set(["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","AA","BB","CC","DD","EE","FF","GG","HH","II","JJ","KK","LL","AAA","BBB","CCC","DDD","EEE","FFF","GGG","HHH","III","JJJ","KKK","LLL","MMM","NNN","OOO","PPP","QQQ","RRR","SSS"]);
var activeDivs = new Set();
var fadedDivs = new Set();
var clicked;

allnodes
	.on("mouseover", function() {	
			activeDivs.clear();
			fadedDivs.clear();
			if (this.id.length === 2) {
			  assoc[this.id].forEach(function(k){
			  	activeDivs.add(k);	
			  });
			} else {
				for (let key in assoc) {
					if (assoc[key].indexOf(this.id) !== -1) {
						activeDivs.add(key);	
					}
				}
			}
			activeDivs.add(this.id);
			
			fadedDivs = nodeset.difference(activeDivs);	
			activeDivs.forEach(function(k, index){
				$("#" + k + " span").toggleClass("hilite");	
			});
			fadedDivs.forEach(function(k, index){
				$("#" + k + " span").toggleClass("lolite");
			});
	})
	.on("mouseout", function(){
		activeDivs.forEach(function(k,index){
			$("#" + k + " span").toggleClass("hilite");
		});
		fadedDivs.forEach(function(k, index){
			$("#" + k + " span").toggleClass("lolite");
		});
	})
	.on("click", function() {
		$("#d3force").css("width", "96%").css("margin-left", "4%");
    $("#d3force1").css("width", "4%").css("margin-right", "96%").css("border-right", "2px solid black");
    //$("#return").css("display","inline");
    clicked = this.id;
    if (this.id.length === 2) {
      treeDraw(this.id);  
    } else {
      treeDraw(activeDivs);
    }	
	});

	function modalClose() {
       $("#d3force").css("width", "0%").css("margin-left", "100%");
       $("#d3force1").css("width", "0%").css("margin-right", "100%");
       $("#d3force1").css("border", "none");
       $("#d3force").empty();
       clicked = null;
    }
    $("#d3force1").on("click", () => {
        modalClose();
    });
  
    document.addEventListener('keyup', (e) => {
        if (e.keyCode == 27) {
            modalClose();
        }
     },{passive:true});
    
    // document.addEventListener('click', (e) => {
    //     console.log(e.x, e.y);
    //  },{passive:true});

//####################################################################


function treeDraw(id) {
    var margin = {top:10, right:10, bottom:10, left:120},
        width = 1020 - margin.right - margin.left,
        height = 620 - margin.top - margin.bottom,
        i = 0, duration = 500,
        root;

    var treemap = d3.tree().size([height, width]);

    //var diagonal = d3.svg.diagonal().projection(function(d) { return [d.y, d.x]; });

    var vis = d3.select("#d3force").append("svg:svg")
       .attr("width", width + margin.right + margin.left)
       .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
    d3.json("js/scaffolding.json", function(json) {
     
      if (typeof id === "string") {
          json.children.forEach(function(r){
            if (id === r.id) {
              root = r;
            }
          });
      } else {
          json.children = json.children.filter(function(a){
            return activeDivs.has(a.id);
          });
          root = json;
          root.name = $("#" + clicked).text();
      }
      root.href = "javascript:modalClose()";
      root = d3.hierarchy(root, function(d) {return d.children;});

      root.x0 = height/2;
      root.y0 = 0;

      function toggleAll(d) {
        if (d.children) {
          d.children.forEach(toggleAll);
          toggle(d);
        }
      }
      
      root.children.forEach(toggleAll);
      update(root);   
    });

    function update(source) {

          var treeData = treemap(root);

          var nodes = treeData.descendants(), 
            links = treeData.descendants().slice(1);

          nodes.forEach(function(d) { 
            d.y = typeof id === "string" ? d.depth * 240 : d.depth * 200;
            d.rx = 100;
            d.ry = 50; 
          });

          var node = vis.selectAll("g.node")
            .data(nodes, function(d) { return d.id || (d.id = ++i); });

          var nodeEnter = node.enter().append("svg:g")
            .attr("class", "node")
            .attr("transform", function(d) { 
              return "translate(" + source.y0 + "," + source.x0 + ")"; 
            })
            .on("click", function(d) { 
                let indno = d.parent.children.indexOf(d);
                if (indno !== null) {
                     let sibs = d.parent.children.slice(0, indno);
                     let sibplus = d.parent.children.slice(indno + 1, d.parent.children.length);
                     sibs = sibs.concat(sibplus);
                     closeChildren({name:"dummy", children:sibs});
                 }
                 toggle(d); 

                 update(d); 
            });
            
            nodeEnter.append("svg:ellipse")
              .attr("rx", function(d){
                  return d.rx;
              })
              .attr("ry", function(d){
                  return d.ry;
              })
              .style("fill", function(d) { return d.depth > 0 ? "#116cff" : "white"; })
              .style("stroke-width", "2");

//################################

        var anchors = nodeEnter.append("svg:a")
            .attr("target", "_blank")
            .attr("xlink:href", function(d) {
                return d.data.href;
            });

        var txts = anchors.append("svg:text")
          .attr("text-anchor", "middle")
          .text(function(d) { 
              return d.data.name; 
          })
          .style("cursor", function(d) {
            return d.depth > 0 ? "pointer" : "inherit"; 
          })
          .style("fill", function(d) { 
            return d.depth > 0 ? "white" : "black"; 
          });

        txts.each(function(d){
          let text = d3.select(this);
          let label = d.data.name;
          let words = label.split(" ").reverse();
          let chars = label.length;
          let totLength = chars * 6;
          let lines = Math.ceil(totLength/175);
          let dy = -1;

          let midline = lines/2;
          let y = lines > 2 ? lines * -2 : 12;
        
          let line = [], maxlength = 150, maxlen = 150, linelen = 0, lineno = 1;
         
          let tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", "-1em");
          while (word = words.pop()) {
            line.push(word);
            tspan.text(line.join(" "));
            linelen = maxlength - (Math.abs(midline - lineno) * 12);
            if (tspan.node().getComputedTextLength() > linelen) {
              tspan.text(line.join(" "));
              let curlen = tspan.node().getComputedTextLength();
              maxlen = maxlen > curlen ? maxlen : curlen;
              tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", lineno++ * 1.1 + dy + "em");
              line = [];
            } 
          }
          if (line.length > 0) { tspan.text(line.join(" ")); }
         
          d.rx = maxlen / 2 + 16;
          //d.ry = lineno * 16 > 45 ? lineno * 16 : 50;
          //console.log("rx: ", d.rx,"ry: ", d.ry,"lines: ", lineno,"totLength: ", totLength,"maxlen: ", maxlen);
        console.log(y,lines,lineno);
        });
           
//###################################################

        var nodeUpdate = nodeEnter.merge(node);

        nodeUpdate.transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

        nodeUpdate.select("ellipse")
          .attr("rx", function(d){
            return d.rx;
          })
          // .attr("ry", function(d){
          //   return d.ry;
          // })
          .style("stroke-width", "2")
          .style("stroke", function(d) { return d.depth > 0 ? "white" : "#116cff"; });

          
        var nodeExit = node.exit().transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
          .remove();

        var link = vis.selectAll("path.link")
          .data(links, function(d) { return d.id; });

        var linkEnter = link.enter().insert("path", "g")
          .attr("class", "link")
          .attr("d", function(d) {
              var o = {x: source.x0, y: source.y0};
              return diagonal(o, o);
          });

        var linkUpdate = linkEnter.merge(link);

        linkUpdate.transition()
          .duration(duration)
          .attr("d", function(d) { return diagonal(d, d.parent); });

        var linkExit = link.exit().transition()
          .duration(duration)
          .attr("d", function(d) {
              var o = {x: source.x, y: source.y};
              return diagonal(o, o);
          })
          .remove();

        nodes.forEach(function(d) {
          d.x0 = d.x;
          d.y0 = d.y;
        });

        function diagonal(s, d) {
            path = `M ${s.y} ${s.x}
                    C ${(s.y + d.y) / 2} ${s.x},
                      ${(s.y + d.y) / 2} ${d.x},
                      ${d.y} ${d.x}`

            return path;
        }
    }

    function closeChildren(el) {   
      if (el.children) { 
        el.children.forEach(closeChildren);
        el._children = el.children;
        el.children = null;
      }
    }

    // Toggle children.
    function toggle(d) {
      if (d.children) {
        d._children = d.children;
        d.children = null;
      } else {
        d.children = d._children;
        d._children = null;
      }
    }
}

</script>
</body></html>


