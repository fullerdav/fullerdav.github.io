<html>  
  <head>
    <style>
         .box, #caption {
            width: 25%;
            margin: auto;
            line-height: 24px;
            padding: 16px;
            background-color: whitesmoke;
            border:  3px inset #abbbc6;

         }

         #caption {
             line-height: 16px;
             font-size:  12px;
         }

         input, button {
            padding: 4px;
            color: #465966;
         }

    </style>

     <script type="text/javascript">      

        const {log} = console; 
        const prefixPrimo = "https://api-na.hosted.exlibrisgroup.com/primo/v1/search?vid=01UCNY_INST:01UCNY_INST&q=title,exact,";
        const postfixPrimo = "&qInclude=rtype,exact,videos&tab=Everything&scope=MyInst_and_CI&lang=eng&offset=0&limit=5&getMore=0&conVoc=false&sort=rank&skipDelivery=true&apikey=l7xxaa726f9cf9f74f048296f374d9ec74f5";
        const prefixCLinker = "https://union.primo.exlibrisgroup.com/discovery/openurl?institution=01UCNY_INST&vid=01UCNY_INST:01UCNY_INST&ctx_ver=Z39.88-2004&ctx_enc=info:ofi%2Fenc:UTF-8&url_ver=Z39.88-2004&url_ctx_fmt=infofi%2Ffmt:kev:mtx:ctx&rfr_id=info:sid%2Fprimo.exlibrisgroup.com:primo4-book-cLinker&rft_val_fmt=info:ofi%2Ffmt:kev:mtx:book&isCitationLinker=Y";
        const error = document.getElementById("error");

        function searchPrimo() {

              let searchterm = document.getElementById("searchterm").value;
              let requestPrimo = prefixPrimo + searchterm + postfixPrimo;
              //error.innerHTML = "";

              fetch(requestPrimo)
                .then(response => response.json())
                .then(titles => { 
                    let titleArray = titles.docs;
                //  let bestTitle = titleArray.filter(title => Math.max(title.pnx.control.score[0]));
                
                    if (titleArray.length > 0) {
                        let {isbn, btitle, addtitle, date, pub} = titles.docs[0].pnx.addata;
                        title = btitle ? btitle : addtitle;
                        openCLinker([isbn, title, date, pub]); 
                    } else {
                        openCLinker([,searchterm,,]); 
                    }
                    
              })
              .catch(console.error);
        }
         
        function openCLinker(data) {
        
            let isbnparm = data[0] ? '&rft.isbn=' + data[0] : "";           
            let titlparm = data[1] ? '&rft.btitle=' + data[1] : "";
            let dateparm = data[2] ? '&rft.pubdate=' + data[2] : "";
            let publparm = data[3] ? '&rft.publisher=' + data[3] : "";
            let typeparm = "&rft.type=video";

            let clinker = prefixCLinker + isbnparm + titlparm + dateparm + publparm + typeparm;
            window.open(clinker);  
        }
    
    </script>

  </head>

  <body>       
   <div class="container">
        <div class="box">
            <input type="text" id="searchterm" name="dvd" size="30" maxlength="80" placeholder="enter title">
            <button type="button" onclick="searchPrimo();">Search for films</button>
        </div>

        <div class="box" id="error">
            <div>
                This search is intended for faculty wanting to discover individual video titles owned licensed by Schaffer Library.  
                If you want to search for a series, say "American Experience", better to 
                <a href='javascript:window.open("https://na04.primo.exlibrisgroup.com/primaws/suprimaExtLogin?institution=01UCNY_INST&lang=en&target-url=https://union.primo.exlibrisgroup.com/discovery/search?query=any,contains,*&tab=Everything&search_scope=MyInst_and_CI&vid=01UCNY_INST:01UCNY_INST&facet=rtype,include,videos,lk&offset=0&authenticationProfile=OKTA_PRIMO_SAML&idpCode=OKTA_PRIMO_SAML&view=01UCNY_INST:01UCNY_INST&auth=SAML&isSilent=false";)'>search Primo</a> directly, with the video facet applied.
            </div>
        </div>
   </div>
   
  </body>
</html>


   
