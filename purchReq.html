<html>
<head>
<title>The Return of the Awesome Form</title>

  <style>
   div#gbcontainer {
      display: flex;
      flex-direction: row;
      position: relative;
      background: rgba(248,248,248,0.95);
      font-weight: 500;
      border: none;
      border-radius:8px;
      height: auto;
      /*max-height: 320px;*/
    }

    ul.flexer {
      margin: 0 auto;
      list-style-type: none;
      padding: 0;
    }
    ul.flexer > li {
      display: flex;
      flex-wrap: wrap;
      align-items: start;
      margin: 0.25em 0;
    }
    ul.flexer > li > label {
      padding: 0.25em;
      letter-spacing: .09em;
      flex: 1 0 8em;
      max-width: 16em;
    }
    input {
      padding: 0.25em;
      border:1px inset #dedede;
    }

    .title {
      font-size: 16px;
      font-weight: 550;
    }

    #errmsg {
      font-family: monospace;
      margin: 8px;
      color: indianred;
    }

  </style>
</head>

<body>
  <div id="gbcontainer">
    <form class="gbform" id="purchaseRequest" method="get" action="https://union.primo.exlibrisgroup.com/discovery/openurl?" target="_blank">
    <ul class="flexer"><li>
        <div class="title">Return of the awesome sugpurchreq form</div> 
      </li><li>
       <div id="errmsg">Enter an ISBN and press TAB</div>
      </li><li>
        <label for="rft.isbn">ISBN</label>
        <input type="text" name="rft.isbn" value="" id="isbnctl">
      </li><li>
        <label for="rft.btitle">Title</label>
        <input type="text" name="rft.btitle" value="" length="40" id="titlectl">
      </li><li>
        <label for="rft.au">Author</label>
        <input tye="text" name="rft.au" value="" id="auctl">
      </li><li>
        <label for="rft.publisher">Publisher/Distributor</label>
        <input type="text" name="rft.publisher" value="" id="pubctl">
      </li><li>  
        <label for="rft.pubdate">Pub Date</label>
        <input type="text" name="rft.pubdate" value="" id="pubdatectl">
       </li></ul>

        <input type="hidden" name="rft.genre" value="book">
        <input type="hidden" name="institution" value="01UCNY_INST">
        <input type="hidden" name="vid" value="01UCNY_INST:01UCNY_INST">
        <input type="hidden" name="rfr_id" value="info:sid%2Fprimo.exlibrisgroup.com:primo4-book-cLinker">
        <input type="hidden" name="url_ver" value="Z39.88-2004"/>
    </form>
  </div>
</body>


<script>

  const isbnCtrl = document.getElementById("isbnctl");
  const errmsg = document.getElementById("errmsg");
  const frm = document.getElementById("purchaseRequest");
  
  var enhanceForm = function(v) {
        frm["rft.pubdate"].value =  v.publishedDate;
        frm["rft.publisher"].value = v.publisher;
        frm["rft.au"].value = v.authors !== undefined ? v.authors[0] : "";;
        frm["rft.btitle"].value =  v.title;    
  }
  
  var getBooksMetadata = function(isn) {
    let xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          const response = JSON.parse(xhr.responseText);
      
          if (response.totalItems > 0) {  
              enhanceForm(response.items[0].volumeInfo);
              errmsg.innerHTML = 'Enter an ISBN and press TAB';
              console.log(response.items);  

              if (searchRequest.totalItems > 1) {
                  errmsg.style.color = 'red';
                  errmsg.innerHTML = 'multiple results.  see console';
              }
          } else {
              errmsg.style.color = 'red';
              errmsg.innerHTML = 'request failed || no metadata found';
          }
          
      } else {
         errmsg.style.color = 'black';
         errmsg.innerHTML = 'getting metadata...';
      }
    };

    xhr.open("GET", "https://www.googleapis.com/books/v1/volumes?q=isbn:" + isn);
    xhr.send();
 } 

  isbnCtrl.addEventListener("blur", function(evt){ 
     let tmpISBN = isbnCtrl.value !== "" ? isbnCtrl.value : false;
     tmpISBN.replace(/[^\dxX]/g, "");
     let isbn = (tmpISBN.length===10 || tmpISBN.length===13) ? tmpISBN : false;  
     console.log("input listener success:", evt.target, isbn, this.value);

     if (isbn) {
       getBooksMetadata(isbn)
     }
  
  }, false);
</script>

</html>


